# 14.sflow的简单介绍及其应用

---

**1 使用场景说明**

- sflow(Sampled Flow，被采样的流)
- 在对网络流量进行监控和分析的过程中，使用sflow系统获取网络设备中的流量。较为详细的讲，sflow agent可以sFlow Agent在指定
接口上按照特定的采样方向和采样比对报文进行采样分析，并将分析的结果通过sFlow报文发送到Collector设备。Collector设备将sflow
报文写入kafka，通过读取kafka中的消息，按照sflow报文的格式解析报文获取对应的信息(IP层的流量traffic、ip等)，使用flink对获取
到的流量信息做实时流处理，实现对网络流量的监控和分析。在解析sflow的报文过程中，主要是根据报文格式对报文json字符串进行反序
列化，sflow的传输的报文内部部分对vxlan报文进行了base64加密，需要对报文内的该段信息进行base64解密然后按照vxlan的格式反序列
化获取相关的信息


**2 sflow介绍**

--2.1 sflow原理
- sFlow系统包含一个嵌入在设备中的sFlow Agent和远端的sFlow Collector。其中，sFlow Agent通过sFlow采样获取接口统计信息和数
据信息，将信息封装成sFlow报文，当sFlow报文缓冲区满或是在sFlow报文缓存时间（缓存时间为1秒）超时后，sFlow Agent会将sFlow报
文发送到指定的sFlow Collector。sFlow Collector对sFlow报文进行分析，并显示分析结果

--2.2 sflow的采样方式
- sFlow Agent提供了两种采样方式供用户从不同的角度分析网络流量状况，分别为Flow采样以及Counter采样
- Flow采样是基于数据包的流采样。sFlow Agent在指定接口上按照特定的采样方向和采样比对报文进行采样分析，并将分析的结果通过
sFlow报文发送到Collector设备
- Counter采样是基于时间的接口统计信息采样。sFlow Agent周期性的获取接口上的流量统计信息、处理器统计信息和内存使用信息，并
将这些信息通过sFlow报文发送给Collector设备
- 在网络流量的监控和分析的项目中，使用了Flow采样，主要基于数据包进行流采样

--2.3 sflow的采样动画演示
- https://sflow.org/process/process_full.htm

**3 关于反序列化解析json字符串的补充**

- flink对json字符串的反序列化解析的jar包基于阿里fastjson实现，文章10中已对使用javaBean与json字符串进行映射做了较为详细的
描述
- 下面提供另一中不使用javaBean而采用Map直接与json字符串映射，此举会省去定义javaBean的过程，但同样需要了解json字符串的格式
- 实例如下
~~~
    待解析的json字符串实例：
        {
          "a":"aa",
          "b":"bb",
          "FlowSamples": [
                    {
                        "SequenceNo": 17128,  
                        "Records": {
                            "RawHeader": {
                                "L2": {                        
                                    "Vlan": 0, 
                                    "EtherType": 2048
                                }, 
                                "Data": "I2cAZAAA"
                            }
                        }
                    }
                ]
        }
        
    利用Map与json字符串映射解析：
        import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.ObjectMapper;
        
        ObjectMapper mapper = new ObjectMapper();
        try {
            Map map = mapper.readValue(value, Map.class);
            if(map.containsKey("a")) {
                System.out.println("a: " + map.get("a"));
            }
            if(map.containsKey("b")) {
                System.out.println("b: " + map.get("b"));
            }
            if (map.containsKey("FlowSamples")) {
                List<Object> list = (List<Object>) map.get("FlowSamples");
                Map map1 = (Map) list.get(0);
                if (map1.containsKey("SequenceNo")) {
                    System.out.println("SequenceNo: " + map1.get("SequenceNo"));
                }
            }
        } catch (Exception e){
        }
~~~


**4 参考**
- 4.1 sflow的介绍：https://support.huawei.com/enterprise/zh/doc/EDOC1000178280/df943e54
- 4.2 sflow的动画演示：https://sflow.org/process/process_full.htm
- 4.3 fastjson的介绍：https://segmentfault.com/a/1190000011212806